# v1.1 IApiClient Design Document

**Versiyon:** v1.1  
**Tarih:** 25 AralÄ±k 2025  
**Durum:** TASK 1 - Design Phase

---

## Overview

Bu dokÃ¼man, VardiyaX mobil uygulamasÄ±ndaki HttpClient kullanÄ±m tutarsÄ±zlÄ±ÄŸÄ±nÄ± Ã§Ã¶zmek iÃ§in tasarlanan centralized IApiClient abstraction'Ä± tanÄ±mlar.

### Problem Statement
```
Mevcut Durum:
- ApiService.cs      â†’ _httpClient.BaseAddress pattern
- AuthService.cs     â†’ _httpClient.BaseAddress pattern  
- UserService.cs     â†’ _baseUrl + full URL pattern
- AuditService.cs    â†’ _baseUrl + full URL pattern
- PushNotificationHandler.cs â†’ _baseUrl + full URL pattern

Sorunlar:
1. Ä°ki farklÄ± pattern = bakÄ±m zorluÄŸu
2. Token handling her serviste tekrarlanÄ±yor
3. Error handling tutarsÄ±z
4. Timeout/retry policy yok
```

---

## Interface Definition

```csharp
namespace ShiftCraft.Mobile.Services;

/// <summary>
/// Centralized API client for all HTTP operations.
/// Single source of truth for base URL, authentication, and error handling.
/// </summary>
public interface IApiClient
{
    /// <summary>
    /// Performs a GET request to the specified endpoint.
    /// </summary>
    /// <typeparam name="T">Expected response type</typeparam>
    /// <param name="endpoint">Relative endpoint (e.g., "employee", "user/1")</param>
    /// <returns>Deserialized response or default(T) on failure</returns>
    Task<T?> GetAsync<T>(string endpoint);

    /// <summary>
    /// Performs a POST request with JSON body.
    /// </summary>
    Task<T?> PostAsync<T>(string endpoint, object? data = null);

    /// <summary>
    /// Performs a PUT request with JSON body.
    /// </summary>
    Task<T?> PutAsync<T>(string endpoint, object data);

    /// <summary>
    /// Performs a DELETE request.
    /// </summary>
    Task<bool> DeleteAsync(string endpoint);

    /// <summary>
    /// Performs a POST request without expecting a response body.
    /// </summary>
    Task<bool> PostAsync(string endpoint, object? data = null);

    /// <summary>
    /// Performs a PUT request without expecting a response body.
    /// </summary>
    Task<bool> PutAsync(string endpoint, object data);
}
```

---

## Implementation Design

### ApiClient Class Structure

```csharp
public class ApiClient : IApiClient
{
    private readonly HttpClient _httpClient;
    private readonly IAuthService _authService;
    private readonly ApiClientOptions _options;

    // Constructor with DI
    public ApiClient(HttpClient httpClient, IAuthService authService, ApiClientOptions options)
    
    // Core HTTP methods
    public Task<T?> GetAsync<T>(string endpoint)
    public Task<T?> PostAsync<T>(string endpoint, object? data = null)
    public Task<T?> PutAsync<T>(string endpoint, object data)
    public Task<bool> DeleteAsync(string endpoint)
    
    // Internal helpers
    private string BuildUrl(string endpoint)
    private void SetAuthHeader()
    private Task HandleUnauthorized()
    private Task<T?> ExecuteWithErrorHandling<T>(Func<Task<HttpResponseMessage>> action)
}
```

### ApiClientOptions Class

```csharp
public class ApiClientOptions
{
    /// <summary>
    /// Base URL for API calls. Must end with '/'.
    /// </summary>
    public string BaseUrl { get; set; } = ApiSettings.BaseUrl;

    /// <summary>
    /// Request timeout in seconds.
    /// </summary>
    public int TimeoutSeconds { get; set; } = 30;

    /// <summary>
    /// Number of retry attempts for transient failures.
    /// </summary>
    public int RetryCount { get; set; } = 1;

    /// <summary>
    /// Delay between retries in milliseconds.
    /// </summary>
    public int RetryDelayMs { get; set; } = 1000;
}
```

---

## Responsibility Boundaries

### IApiClient Responsibilities
| Responsibility | Included | Notes |
|----------------|----------|-------|
| Base URL management | âœ… | Single source of truth |
| Token injection | âœ… | Automatic Bearer token |
| Request timeout | âœ… | Configurable |
| Retry policy | âœ… | Transient failures only |
| JSON serialization | âœ… | System.Text.Json |
| Error handling | âœ… | Centralized |
| Unauthorized redirect | âœ… | Auto-logout on 401 |

### Service Responsibilities (After Migration)
| Responsibility | Service | Notes |
|----------------|---------|-------|
| Business logic | Each service | Unchanged |
| Endpoint paths | Each service | Relative paths only |
| Response mapping | Each service | DTO transformations |
| Domain exceptions | Each service | Business errors |

### NOT in IApiClient Scope
- âŒ Business logic
- âŒ Caching
- âŒ Offline support
- âŒ Request queuing
- âŒ Analytics/logging (v1.2)

---

## Error Handling Strategy

```csharp
// Centralized error handling in ApiClient
private async Task<T?> ExecuteWithErrorHandling<T>(Func<Task<HttpResponseMessage>> action)
{
    try
    {
        // Token expiry check
        if (_authService.IsTokenExpired())
        {
            await HandleUnauthorized();
            throw new UnauthorizedAccessException("Oturum sÃ¼resi doldu.");
        }

        SetAuthHeader();
        var response = await action();

        // Status code handling
        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
            case HttpStatusCode.Created:
                return await response.Content.ReadFromJsonAsync<T>();
            
            case HttpStatusCode.NoContent:
                return default;
            
            case HttpStatusCode.Unauthorized:
                await HandleUnauthorized();
                throw new UnauthorizedAccessException("Oturum sÃ¼resi doldu.");
            
            case HttpStatusCode.Forbidden:
                throw new ApiException("Bu iÅŸlem iÃ§in yetkiniz yok.", 403);
            
            case HttpStatusCode.NotFound:
                throw new ApiException("KayÄ±t bulunamadÄ±.", 404);
            
            case HttpStatusCode.Conflict:
                throw new ApiException("KayÄ±t zaten mevcut.", 409);
            
            case HttpStatusCode.BadRequest:
                var content = await response.Content.ReadAsStringAsync();
                throw new ApiException($"GeÃ§ersiz istek: {content}", 400);
            
            default:
                throw new ApiException($"Sunucu hatasÄ±: {response.StatusCode}", (int)response.StatusCode);
        }
    }
    catch (HttpRequestException ex)
    {
        throw new ApiException($"Sunucuya baÄŸlanÄ±lamadÄ±: {ex.Message}", 0);
    }
    catch (TaskCanceledException)
    {
        throw new ApiException("Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ±.", 0);
    }
}
```

### Custom Exception Class

```csharp
public class ApiException : Exception
{
    public int StatusCode { get; }
    
    public ApiException(string message, int statusCode) : base(message)
    {
        StatusCode = statusCode;
    }
}
```

---

## Environment Configuration

```csharp
public static class ApiSettings
{
    // Environment-aware base URL
    public static string BaseUrl => 
#if DEBUG
        "https://shiftcraft-api-dev.azurewebsites.net/api/v1/";
#else
        "https://shiftcraft-api-prod.azurewebsites.net/api/v1/";
#endif

    // Endpoint constants (unchanged)
    public static class Endpoints
    {
        public const string Login = "auth/login";
        public const string Employees = "employee";
        public const string WeeklySchedules = "weeklyschedule";
        public const string RuleViolations = "ruleviolation";
    }
}
```

---

## DI Registration

```csharp
// MauiProgram.cs
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
    
    // HttpClient with timeout
    builder.Services.AddHttpClient<IApiClient, ApiClient>(client =>
    {
        client.Timeout = TimeSpan.FromSeconds(30);
    });
    
    // Options
    builder.Services.AddSingleton(new ApiClientOptions
    {
        BaseUrl = ApiSettings.BaseUrl,
        TimeoutSeconds = 30,
        RetryCount = 1
    });
    
    // Services (will use IApiClient after migration)
    builder.Services.AddSingleton<IAuthService, AuthService>();
    builder.Services.AddSingleton<IApiService, ApiService>();
    builder.Services.AddSingleton<IUserService, UserService>();
    builder.Services.AddSingleton<IAuditService, AuditService>();
    builder.Services.AddSingleton<IPushNotificationHandler, PushNotificationHandler>();
    
    return builder.Build();
}
```

---

## Migration Checklist

### Pre-Migration
- [ ] IApiClient interface oluÅŸtur
- [ ] ApiClient implementasyonu yaz
- [ ] ApiClientOptions tanÄ±mla
- [ ] ApiException class ekle
- [ ] DI registration ekle
- [ ] Build ve launch test

### Service Migration (SÄ±rayla)

#### 1. AuthService
- [ ] IApiClient inject et
- [ ] LoginAsync'i IApiClient kullanacak ÅŸekilde gÃ¼ncelle
- [ ] Build test
- [ ] Login flow test

#### 2. ApiService
- [ ] IApiClient inject et
- [ ] TÃ¼m metodlarÄ± gÃ¼ncelle
- [ ] Build test
- [ ] Employees/Schedules/Violations test

#### 3. UserService
- [ ] IApiClient inject et
- [ ] TÃ¼m metodlarÄ± gÃ¼ncelle
- [ ] Build test
- [ ] Users page test

#### 4. AuditService
- [ ] IApiClient inject et
- [ ] TÃ¼m metodlarÄ± gÃ¼ncelle
- [ ] Build test
- [ ] Audit logs test

#### 5. PushNotificationHandler
- [ ] IApiClient inject et
- [ ] TÃ¼m metodlarÄ± gÃ¼ncelle
- [ ] Build test
- [ ] Notification settings test

### Post-Migration
- [ ] Eski HttpClient kullanÄ±mlarÄ±nÄ± kaldÄ±r
- [ ] Code review
- [ ] Full regression test
- [ ] Performance baseline

---

## Backward Compatibility

### Garantiler
1. **AynÄ± API endpoint'leri** - DeÄŸiÅŸiklik yok
2. **AynÄ± response format** - DTO'lar aynÄ±
3. **AynÄ± error mesajlarÄ±** - TÃ¼rkÃ§e mesajlar korunuyor
4. **AynÄ± timeout** - 30 saniye
5. **AynÄ± auth flow** - Bearer token, auto-logout

### Breaking Change Riski
```
ğŸŸ¢ LOW RISK

TÃ¼m deÄŸiÅŸiklikler internal implementation.
Public API (servis metodlarÄ±) deÄŸiÅŸmiyor.
```

---

## Test Strategy

### Unit Tests
```csharp
[Fact]
public async Task GetAsync_ReturnsData_WhenSuccessful()
{
    // Arrange
    var mockHandler = new MockHttpMessageHandler(HttpStatusCode.OK, jsonResponse);
    var client = new ApiClient(new HttpClient(mockHandler), mockAuth, options);
    
    // Act
    var result = await client.GetAsync<List<Employee>>("employee");
    
    // Assert
    Assert.NotNull(result);
    Assert.NotEmpty(result);
}

[Fact]
public async Task GetAsync_ThrowsUnauthorized_When401()
{
    // Arrange
    var mockHandler = new MockHttpMessageHandler(HttpStatusCode.Unauthorized);
    var client = new ApiClient(new HttpClient(mockHandler), mockAuth, options);
    
    // Act & Assert
    await Assert.ThrowsAsync<UnauthorizedAccessException>(
        () => client.GetAsync<Employee>("employee/1"));
}
```

### Integration Tests (Appium)
- App launch â†’ Login â†’ Main page
- Each hamburger menu page
- Logout flow

---

## Timeline

| Task | Efor | Durum |
|------|------|-------|
| Interface design | 1h | âœ… DONE |
| Implementation | 2h | â³ NEXT |
| AuthService migration | 30m | â³ |
| ApiService migration | 30m | â³ |
| UserService migration | 30m | â³ |
| AuditService migration | 30m | â³ |
| PushNotificationHandler migration | 30m | â³ |
| Testing | 2h | â³ |
| **Total** | **~7h** | |

---

*Design Document v1.0*  
*HazÄ±rlayan: Kiro AI Assistant*
